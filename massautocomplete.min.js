!function(){"use strict";angular.module("MassAutoComplete",[]).provider("massAutocompleteConfig",function(){var e=this;e.KEYS={TAB:9,ESC:27,ENTER:13,UP:38,DOWN:40},e.EVENTS={KEYDOWN:"keydown",RESIZE:"resize",BLUR:"blur"},e.DEBOUNCE={position:150,attach:300,suggest:200,blur:150},e.generate_random_id=function(e){return e+"_"+Math.random().toString().substring(2)},e.position_autocomplete=function(e,t){var n=t[0].getBoundingClientRect(),o=document.body.scrollTop||document.documentElement.scrollTop||window.pageYOffset,i=document.body.scrollLeft||document.documentElement.scrollLeft||window.pageXOffset;e[0].style.top=n.top+n.height+o+"px",e[0].style.left=n.left+i+"px",e[0].style.width=n.width+"px"},this.$get=function(){return e}}).directive("massAutocomplete",["massAutocompleteConfig","$timeout","$window","$document","$q",function(e,t,n,o,i){return{restrict:"A",scope:{options:"&massAutocomplete"},transclude:!0,template:'<span ng-transclude></span><div class="ac-container" aria-autocomplete="list" role="listbox" ng-show="show_autocomplete" style="position:absolute;"><ul class="ac-menu"> <li ng-repeat="result in results" ng-if="$index > 0" class="ac-menu-item" role="option" id="{{result.id}}" ng-class="$index == selected_index ? \'ac-state-focus\': \'\'"><a href ng-click="apply_selection($index)" ng-bind-html="result.label"></a></li></ul></div>',link:function(e,t){e.container=angular.element(t[0].getElementsByClassName("ac-container")[0])},controller:["$scope",function(a){function l(){a.show_autocomplete=!0}function c(){a.show_autocomplete=!1,f()}function s(e,t,n){var o;return function(){var i=this,a=arguments,l=function(){o=null,n||e.apply(i,a)},c=n&&!o;clearTimeout(o),o=setTimeout(l,t),c&&e.apply(i,a)}}function r(t){return(!t.id||""===t.id)&&(t.id=e.generate_random_id("ac_element"),!0)}function u(){e.position_autocomplete(a.container,b)}function d(t,n){a.selected_index=0,a.waiting_for_suggestion=!0,"string"==typeof t&&t.length>0?i.when(S.suggest(t),function(o){b&&b===n&&(o&&o.length>0?(o.forEach(function(t){t.id||(t.id=e.generate_random_id("ac_item"))}),a.results=[{value:t,label:"",id:""}].concat(o),l(),S.auto_select_first&&m(1)):(a.results=[],c()))},function(e){c(),S.on_error&&S.on_error(e)})["finally"](function(){a.waiting_for_suggestion=!1}):(a.waiting_for_suggestion=!1,c(),a.$apply())}function p(e,t,n){b!==t&&(b&&g.detach(),t[0]===o[0].activeElement&&(n.on_attach&&n.on_attach(),b=t,v=e,S=n,N=e.$viewValue,T=r(t),a.container[0].setAttribute("aria-labelledby",b.id),a.results=[],a.selected_index=-1,_(),w=a.$watch(function(){return e.$modelValue},function(e){e!==y&&(u(),D(e,b))})))}function E(e){v.$modelValue!==e&&(v.$setViewValue(e),v.$render())}function f(){a.selected_index=-1,a.container[0].removeAttribute("aria-activedescendant")}function m(e){var t=a.results[e];return a.selected_index=e,a.container[0].setAttribute("aria-activedescendant",t.id),t}function _(){angular.element(n).bind(e.EVENTS.RESIZE,x),h[e.EVENTS.BLUR]=function(){t(function(){b&&b[0]===o[0].activeElement||g.detach()},V.debounce_blur)},b.bind(e.EVENTS.BLUR,h[e.EVENTS.BLUR]),h[e.EVENTS.KEYDOWN]=function(t){if(!t.shiftKey)switch(t.keyCode){case e.KEYS.ESC:a.show_autocomplete?(c(),a.$apply()):b.val(N);break;case e.KEYS.ENTER:a.show_autocomplete&&a.selected_index>0&&!a.waiting_for_suggestion&&(a.EnterKey=!0,a.apply_selection(a.selected_index),t.stopPropagation(),t.preventDefault(),A=[]),c(),a.$apply();break;case e.KEYS.TAB:if(!a.show_autocomplete)break;t.preventDefault();case e.KEYS.DOWN:A.push(b[0].selectionStart),S.selStart=A[0],a.selectionStart=t.target.selectionStart,a.results.length>0&&(a.show_autocomplete?m(a.selected_index+1>a.results.length-1?0:a.selected_index+1):(l(),m(0)),a.$apply());break;case e.KEYS.UP:a.selectionStart=t.target.selectionStart,a.show_autocomplete&&(t.preventDefault(),m(a.selected_index-1>=0?a.selected_index-1:a.results.length-1),a.$apply())}},b.bind(e.EVENTS.KEYDOWN,h[e.EVENTS.KEYDOWN])}var g=this,h={};h[e.EVENTS.BLUR]=null,h[e.EVENTS.KEYDOWN]=null,h[e.EVENTS.RESIZE]=null;var b,v,S,N,w,y,T,$=a.options()||{},V={debounce_position:$.debounce_position||e.DEBOUNCE.position,debounce_attach:$.debounce_attach||e.DEBOUNCE.attach,debounce_suggest:$.debounce_suggest||e.DEBOUNCE.suggest,debounce_blur:$.debounce_blur||e.DEBOUNCE.blur},A=[];a.show_autocomplete=!1;var x=s(u,V.debounce_position),D=s(d,V.debounce_suggest);g.attach=s(p,V.debounce_attach),g.detach=function(){if(b){var t=b.val();E(t),S.on_detach&&S.on_detach(t),b.unbind(e.EVENTS.KEYDOWN,h[e.EVENTS.KEYDOWN]),b.unbind(e.EVENTS.BLUR,h[e.EVENTS.BLUR])}c(),a.container[0].removeAttribute("aria-labelledby"),angular.element(n).unbind(e.EVENTS.RESIZE,h[e.EVENTS.RESIZE]),w&&w(),a.selected_index=a.results=void 0,v=b=N=void 0},a.apply_selection=function(e){if(!(!a.show_autocomplete||e>a.results.length||e<0)){var t="";if(S.multi_select){var n=b[0],o=n.value,i="",l=0;a.EnterKey&&(n.selectionStart=S.selStart,a.EnterKey=!1),S.from_scope&&(n.selectionStart=S.selStart+1);var s=o.slice(0,n.selectionStart).length;if(S.from_scope||s>0&&" "!==o.charAt(s-1)&&(" "===o.charAt(s)||""===o.charAt(s))){for(var r=o.slice(0,s),u=s;u>=0;u--)if(" "===r.charAt(u)){i=r.slice(u+1,s),l=u+1;break}""===i&&(i=r);var d=n.value;t=m(e),y=t.value;var p=d.slice(l+i.length);d=d.slice(0,l)+y+p;var f=y.length-i.length,_=s+f;S.from_scope||(d=d.slice(0,_)+" "+d.slice(_,d.length)),n.focus(),E(d),S.from_scope||n.setSelectionRange(_+1,_+1),c(),t.value=d,S.from_scope=!1}}else t=m(e),y=t.value,E(t.value),c();S.on_select&&S.on_select(t)}},a.$on("$destroy",function(){g.detach(),a.container.remove()})}]}}]).directive("massAutocompleteItem",function(){return{restrict:"A",require:["^massAutocomplete","ngModel"],scope:{massAutocompleteItem:"&"},link:function(e,t,n,o){n.$set("autocomplete","off");var i=o[0],a=o[1];t.bind("focus",function(){var n=e.massAutocompleteItem();if(!n)throw new Error("Invalid options");i.attach(a,t,n)})}}})}();